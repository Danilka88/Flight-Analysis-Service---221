# Система Анализа Полетной Активности БАС

## 1. Обзор

**Система Анализа Полетной Активности** — это полнофункциональное full-stack веб-приложение, предназначенное для обработки, анализа и визуализации данных о полетах беспилотных авиационных систем (БАС).

- **Бэкенд**: Написан на **Python** с использованием фреймворка **FastAPI**. Он отвечает за парсинг `.xlsx` файлов с полетными данными, их сохранение и предоставление через REST API.
- **Фронтенд**: Современный одностраничный интерфейс (SPA), разработанный на **React** и **TypeScript**. Он обеспечивает интерактивную визуализацию данных, включая дашборды, графики и карты.

Приложение позволяет пользователям загружать файлы с полетными планами, после чего система автоматически их обрабатывает и обновляет все визуализации.

## 2. Ключевые возможности

- **Загрузка и парсинг данных**: Пользователи могут загружать `.xlsx` файлы через веб-интерфейс. Бэкенд обрабатывает их и сохраняет в качестве основного источника данных.
- **Персистентное хранение**: Обработанные данные сохраняются в файл `data/base_data.json`, который служит единой базой данных для всего приложения. Это обеспечивает сохранность данных даже после перезапуска сервера.
- **Интерактивный дашборд**: Главная страница с ключевыми метриками (KPI), такими как общее количество полетов, средняя длительность, пиковая нагрузка и т.д.
- **Визуализация данных**: Набор графиков и диаграмм для анализа:
  - Динамика полетов во времени.
  - Распределение активности по часам.
  - Анализ по регионам и типам воздушных судов.
  - Распределение полетов по высотным эшелонам.
- **Список полетов и детализация**: Табличное представление всех полетов с возможностью фильтрации, сортировки и перехода на страницу с подробной информацией о каждом полете, включая RAW-телеграммы и схему маршрута.
- **Ролевая модель**: Базовая симуляция ролей "Оператор" и "Администратор".

## 3. Структура проекта

Проект организован следующим образом:

-   `./`: Корневая директория проекта. Содержит основные файлы бэкенда (`main.py`, `parsing.py`, `geojson_converter.py`), файлы зависимостей (`requirements.txt`, `package.json`), а также документацию (`README.md`).
-   `data/`: Содержит файлы данных, используемые проектом.
    -   `base_data.json`: Основной источник данных после парсинга.
    -   `russia_regions.geojson`: Географические данные для визуализации регионов России.
    -   `2025.xlsx`: Пример файла с полетными данными.
    -   `example.json`, `example_mini.json`: Примеры JSON-данных.
-   `database/`: Директория для работы с базой данных.
    -   `alembic/`: Содержит скрипты для миграций базы данных (используется Alembic).
-   `Russia-Admin-Shapemap-main/`: Содержит географические шейп-файлы административных границ России, используемые для картографической визуализации.
-   `ui/`: Директория фронтенд-приложения на React/TypeScript.
    -   `components/`: Переиспользуемые UI-компоненты.
    -   `pages/`: Страницы приложения.
    -   `store/`: Управление состоянием приложения с помощью Redux Toolkit.
    -   `utils/`: Вспомогательные утилиты и функции.

## 4. Технологический стек

-   **Бэкенд**:
    -   Python 3.10+
    -   FastAPI (веб-фреймворк)
    -   Uvicorn (ASGI-сервер)
    -   Pandas (для парсинга Excel)
    -   python-multipart (для обработки загрузки файлов)
    -   `parsing.py`: Модуль для парсинга данных из Excel-файлов.
    -   `geojson_converter.py`: Модуль для работы с GeoJSON данными.

-   **Фронтенд**:
    -   React (библиотека для создания пользовательских интерфейсов)
    -   TypeScript (типизированный JavaScript)
    -   Vite (сборщик проекта)
    -   Redux Toolkit (управление состоянием)
    -   React Router (навигация)
    -   Tailwind CSS (стилизация)
    -   Recharts (графики и диаграммы)

### Хранение, Безопасность и Аутентификация (для будущего расширения)

-   **SQLAlchemy**: ORM для работы с PostgreSQL/PostGIS, включая GiST-индексы и хранение истории (до года+).
    -   *Причины*: ТЗ рекомендует Open Source СУБД как PostgreSQL с PostGIS для пространственных данных (разделы 3.4, 3.6.1). Поддерживает архивный слой без удаления.
    -   *Альтернатива*: Psycopg2 (для raw SQL, если ORM не нужен) или PyMongo (для MongoDB как альтернативы).

-   **GeoAlchemy2**: Расширение SQLAlchemy для геоданных в PostGIS.
    -   *Причины*: Пространственные запросы и индексы (раздел 3.4).

-   **Authlib**: Для реализации OpenID Connect (с Keycloak).
    -   *Причины*: ТЗ требует аутентификации/авторизации через OpenID Connect, TLS и PGP-шифрование at-rest (раздел 4). Authlib интегрируется с FastAPI.
    -   *Альтернатива*: PyJWT (для токенов) или Cryptography (для PGP/TLS).

-   **Cryptography**: Для шифрования данных at-rest (PGP).
    -   *Причины*: Соответствие ФЗ-149/152 и ГОСТам (разделы 3.6.9, 4).

## 5. Установка и запуск

Для полного запуска приложения необходимо отдельно запустить бэкенд-сервер и фронтенд-клиент.

### Шаг 1: Настройка и запуск Бэкенда

1.  **Перейдите в корневую директорию проекта:**
    ```bash
    cd /Users/danil_ka88/Desktop/moscow/project
    ```

2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    # Создание окружения
    python3 -m venv .venv

    # Активация на macOS/Linux
    source .venv/bin/activate

    # Активация на Windows
    # .\.venv\Scripts\activate
    ```

3.  **Установите зависимости Python:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Запустите бэкенд-сервер:**
    ```bash
    uvicorn main:app --host 0.0.0.0 --port 8000
    ```
    Сервер будет доступен по адресу `http://localhost:8000`.

### Шаг 2: Настройка и запуск Фронтенда

1.  **Откройте новый терминал и перейдите в директорию `ui`:**
    ```bash
    cd /Users/danil_ka88/Desktop/moscow/project/ui
    ```

2.  **Установите зависимости Node.js:**
    ```bash
    npm install
    ```

3.  **Запустите сервер для разработки фронтенда:**
    ```bash
    npm run dev
    ```
    Веб-интерфейс будет доступен по адресу `http://localhost:5173` (порт может отличаться в зависимости от конфигурации Vite).

### Шаг 3: Начало работы

1.  Откройте в браузере `http://localhost:5173` (или другой порт, указанный Vite).
2.  Войдите в систему (любые данные для входа подойдут, для прав администратора используйте логин `admin`).
3.  Перейдите на страницу **"Загрузка"** и загрузите `.xlsx` файл с данными о полетах (например, `data/2025.xlsx`).
4.  После успешной обработки данных, все дашборды и отчеты автоматически обновятся.

## 6. Тестирование

### Бэкенд

Для запуска тестов бэкенда используйте `pytest`:

1.  Убедитесь, что вы находитесь в корневой директории проекта и виртуальное окружение активировано.
2.  Выполните команду:
    ```bash
    pytest
    ```
    Тесты находятся в файле `test_parsing.py`.

### Фронтенд

(Если есть тесты для фронтенда, добавьте инструкции здесь. Например, `npm test` или `npm run test`.)

## 7. Архитектура данных и API

### Основной флоу данных

1.  Пользователь загружает `.xlsx` файл через UI на эндпоинт `POST /api/upload`.
2.  Бэкенд парсит файл и сохраняет результат в `data/base_data.json`, перезаписывая старый файл.
3.  Фронтенд запрашивает данные для отображения с эндпоинта `GET /api/flights`, который читает `data/base_data.json`.
4.  После загрузки нового файла фронтенд автоматически инициирует повторный запрос на `GET /api/flights`, чтобы обновить интерфейс.

### API Эндпоинты

-   `GET /`: Служебный эндпоинт для проверки работоспособности сервера.
-   `POST /api/upload`: Принимает `multipart/form-data` с `.xlsx` файлом в поле `file`. Парсит его и сохраняет результат в `data/base_data.json`.
-   `GET /api/flights`: Возвращает содержимое файла `data/base_data.json` в виде JSON-массива.

## 8. Структура JSON-вывода

Каждый элемент в JSON-массиве, возвращаемом эндпоинтом `/api/flights`, имеет следующую структуру:

```json
{
  "Центр ЕС ОрВД": "Название центра (строка)",
  "SHR_raw": "Исходная строка SHR (строка)",
  "DEP_raw": "Исходная строка DEP (строка)",
  "ARR_raw": "Исходная строка ARR (строка, может быть null)",
  "parsed_data": { ... } // Подробная структура распарсенных данных
}
```